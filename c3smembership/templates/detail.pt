<html xmlns="http://www.w3.org/1999/xhtml"
      xml:lang="en"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      metal:use-macro="backend">
  <tal:block metal:fill-slot="javascript">
    <script src="${request.static_url('c3smembership:static/jquery/jquery.min.js')}"
            type="text/javascript"></script>
      <script type="text/javascript">
        $().ready(function() {
            $("#dues18_05_reduce_submit").click(function(event) {
                reduction_amount = $("#dues18_05_form input[name='amount']").val();
                answer = confirm("Are you sure you want to reduce the dues for ${member.firstname} ${member.lastname} to " + reduction_amount + "?");
                if(answer) {
                    $("#dues18_05_form input[name='confirmed']").val("yes");
                } else {
                    event.preventDefault();
                }
            });
            $("#dues18_06_reduce_submit").click(function(event) {
                reduction_amount = $("#dues18_06_form input[name='amount']").val();
                answer = confirm("Are you sure you want to reduce the dues for ${member.firstname} ${member.lastname} to " + reduction_amount + "?");
                if(answer) {
                    $("#dues18_06_form input[name='confirmed']").val("yes");
                } else {
                    event.preventDefault();
                }
            });
            $("#dues18_07_reduce_submit").click(function(event) {
                reduction_amount = $("#dues18_07_form input[name='amount']").val();
                answer = confirm("Are you sure you want to reduce the dues for ${member.firstname} ${member.lastname} to " + reduction_amount + "?");
                if(answer) {
                    $("#dues18_07_form input[name='confirmed']").val("yes");
                } else {
                    event.preventDefault();
                }
            });
            $("#dues18_08_reduce_submit").click(function(event) {
                reduction_amount = $("#dues18_08_form input[name='amount']").val();
                answer = confirm("Are you sure you want to reduce the dues for ${member.firstname} ${member.lastname} to " + reduction_amount + "?");
                if(answer) {
                    $("#dues18_08_form input[name='confirmed']").val("yes");
                } else {
                    event.preventDefault();
                }
            });
            $("#dues18_09_reduce_submit").click(function(event) {
                reduction_amount = $("#dues18_09_form input[name='amount']").val();
                answer = confirm("Are you sure you want to reduce the dues for ${member.firstname} ${member.lastname} to " + reduction_amount + "?");
                if(answer) {
                    $("#dues18_09_form input[name='confirmed']").val("yes");
                } else {
                    event.preventDefault();
                }
            });

            $("#dues18_10_reduce_submit").click(function(event) {
                reduction_amount = $("#dues18_10_form input[name='amount']").val();
                answer = confirm("Are you sure you want to reduce the dues for ${member.firstname} ${member.lastname} to " + reduction_amount + "?");
                if(answer) {
                    $("#dues18_10_form input[name='confirmed']").val("yes");
                } else {
                    event.preventDefault();
                }
            });

            $("#dues18_11_reduce_submit").click(function(event) {
                reduction_amount = $("#dues18_11_form input[name='amount']").val();
                answer = confirm("Are you sure you want to reduce the dues for ${member.firstname} ${member.lastname} to " + reduction_amount + "?");
                if(answer) {
                    $("#dues18_11_form input[name='confirmed']").val("yes");
                } else {
                    event.preventDefault();
                }
            });

            $("#dues18_12_reduce_submit").click(function(event) {
                reduction_amount = $("#dues18_12_form input[name='amount']").val();
                answer = confirm("Are you sure you want to reduce the dues for ${member.firstname} ${member.lastname} to " + reduction_amount + "?");
                if(answer) {
                    $("#dues18_12_form input[name='confirmed']").val("yes");
                } else {
                    event.preventDefault();
                }
            });
        });
      </script>
  </tal:block>
  <tal:block metal:fill-slot="middle">
    <?python
          from datetime import date
    ?>
      <p>
        Please <a href="${request.route_url('logout')}">log out</a>
        when you are done.
        Or go
        <a href="${request.route_url('dashboard')}"
           class="btn btn-success"
           >back to dashboard</a>
        or the
        <a href="${request.route_url('membership_listing_backend')}"
           class="btn btn-success"
           >memberships</a>.
      </p>

      <h1>Details for Member Application #${member.id}</h1>
      <a href="${request.route_url('edit', _id=member.id)}" class="btn btn-warning">edit</a>
      <a href="${request.route_url('delete_entry', memberid=member.id)}" class="btn btn-danger">delete</a>
      <table class="table table-striped">
        <tr>
          <td>code</td>
          <td>${member.email_confirm_code}</td>
        </tr>
        <tr>
          <td>firstname</td>
          <td>${member.firstname}</td>
        </tr>
        <tr>
          <td>lastname</td>
          <td>${member.lastname}</td>
        </tr>
        <tr>
          <td>email</td>
          <td><a href="mailto:${member.email}">${member.email}</a></td>
        </tr>
        <tr>
          <td>email confirmed?</td>
          <td>${python: u'Yes' if member.email_is_confirmed else u'No.'}</td>
        </tr>
        <tr>
          <td>address1</td>
          <td>${member.address1}</td>
        </tr>
        <tr>
          <td>address2</td>
          <td>${member.address2}</td>
        </tr>
        <tr>
          <td>postcode</td>
          <td>${member.postcode}</td>
        </tr>
        <tr>
          <td>city</td>
          <td>${member.city}</td>
        </tr>
        <tr>
          <td>country</td>
          <td>${member.country}</td>
        </tr>
        <tr>
          <td>locale</td>
          <td>${member.locale}</td>
        </tr>
        <tr>
          <td>date_of_birth</td>
          <td>${member.date_of_birth}</td>
        </tr>
      </table>

      <h3>Membership Meta</h3>
    <table class="table table-striped">
        <tr>
            <td>membership_accepted</td>
            <td>
                ${'Yes' if member.membership_accepted else 'No'}
            </td>
        </tr>
        <tr tal:condition="member.membership_accepted">
            <td>membership_number</td>
            <td>
                ${member.membership_number}
            </td>
        </tr>
        <tr tal:condition="member.membership_accepted">
            <td>membership_date</td>
            <td>${member.membership_date.strftime('%Y-%m-%d') if member.membership_date is not None else ''}</td>
        </tr>
        <tr>
            <td>is_duplicate ?</td>
            <td>${'Yes' if member.is_duplicate else 'No/Unknown'}</td>
        </tr>
        <tr tal:condition="member.is_duplicate">
            <td>is duplicate of</td>
            <td>
                <a href="${request.route_url('detail', memberid=member.is_duplicate_of)}">
                    ${member.is_duplicate_of}
                </a>
            </td>
        </tr>
        <tr>
            <td>membership loss date</td>
            <td>${member.membership_loss_date.strftime('%Y-%m-%d') if member.membership_loss_date is not None else ''}</td>
        </tr>
        <tr>
            <td>membership loss type</td>
            <td>${member.membership_loss_type}</td>
        </tr>
        <tr>
            <td><a name="comment"></a>staff comment</td>
            <td>${member.accountant_comment}</td>
        </tr>
    </table>


      <a name="membership_info"></a>
      <h3>Membership Info</h3>

      <table class="table table-striped">
        <tr tal:condition="member.signature_received and member.payment_received and not member.membership_accepted">
          <td>ready for membership!</td>
          <td><!--! turn application into a member -->
            <div tal:condition="member.signature_received
                                and member.payment_received">
              <a href="${request.route_url('make_member',
                       afm_id=member.id)}"
                 class="btn btn-success">make member</a>
            </div>
          </td>
        </tr>
        <tr>
          <td>entity type</td>
          <td>${u'KÃ¶rperschaft' if member.is_legalentity else 'Person'}</td>
        </tr>
        <tr>
          <td>membership type</td>
          <td>${member.membership_type}</td>
        </tr>
        <tr>
          <td>member_of_colsoc</td>
          <td>${'Yes' if member.member_of_colsoc else 'No'}</td>
        </tr>
        <tr>
          <td>name_of_colsoc</td>
          <td>${member.name_of_colsoc}</td>
        </tr>
        <tr>
          <td>date_of_submission</td>
          <td>${member.date_of_submission.strftime('%Y-%m-%d')}</td>
        </tr>
        <tr>
          <td>signature received?</td>
          <td>
            <div tal:condition="not member.signature_received">
              <div class="btn btn-danger"
                   title="immer noch nicht">Nein</div>
              <!--! re-create hte Application for Membership PDF -->
              <a href="${request.route_url('regenerate_pdf', code=member.email_confirm_code)}"
                 download="${request.route_url('regenerate_pdf', code=member.email_confirm_code)}"
                 class="btn btn-success">
                PDF generieren
              </a>
              <a href="${request.route_url('switch_sig', memberid=member.id)}"
                 class="btn btn-primary">
                Eingang bestÃ¤tigen
              </a>
              <a href="${request.route_url('mail_sig_reminder', memberid=member.id)}"
                 class="btn btn-warning">
                Erinnerung senden
              </a>
            </div>
            <div tal:condition="member.signature_received">
              <a href="${request.route_url('switch_sig', memberid=member.id)}"
                 class="btn btn-success"
                 title="${member.signature_received_date} (anklicken zum verneinen)">
                Ja</a>
              <a href="${request.route_url('mail_sig_confirmation', memberid=member.id)}"
                 class="btn btn-success"
                 tal:condition="not member.signature_confirmed">
                BestÃ¤tigungs-E-Mail verschicken</a>
              <a href="${request.route_url('mail_sig_confirmation', memberid=member.id)}"
                 class="btn btn-success"
                 tal:condition="member.signature_confirmed">
                BestÃ¤tigungs-E-Mail erneut verschicken</a>
            </div>
          </td>
        </tr>
        <tr tal:condition="member.signature_received">
          <td>signature reception date</td><td>${member.signature_received_date}</td>
        </tr>
        <tr>
          <td>signature confirmed (mail sent)?</td><td>${member.signature_confirmed or "No"}</td>
        </tr>
        <tr tal:condition="member.signature_confirmed">
          <td>signature confirmation date</td><td>${member.signature_confirmed_date}</td>
        </tr>
        <tr>
          <td>payment received?</td>
          <td>
            <div tal:condition="not member.payment_received">
              <div class="btn btn-danger">Nein</div>
              <a href="${request.route_url('switch_pay', memberid=member.id)}"
                 class="btn btn-primary">
                Zahlungseingang bestÃ¤tigen
              </a>
              <a href="${request.route_url('mail_pay_reminder', memberid=member.id)}"
                 class="btn btn-warning">
                Erinnerung senden
              </a>
            </div>
            <div tal:condition="member.payment_received">
              <a href="${request.route_url('switch_pay', memberid=member.id)}"
                 class="btn btn-success"
                 title="${member.payment_received_date} (anklicken zum verneinen)">
                Ja</a>
              <a href="${request.route_url('mail_pay_confirmation', member_id=member.id)}"
                 class="btn btn-success"
                 tal:condition="not member.payment_confirmed">
                BestÃ¤tigungs-E-Mail verschicken</a>
              <a href="${request.route_url('mail_pay_confirmation', member_id=member.id)}"
                 class="btn btn-success"
                 tal:condition="member.payment_confirmed">
                BestÃ¤tigungs-E-Mail erneut verschicken</a>
            </div>
          </td>
        </tr>
        <tr tal:condition="member.payment_received">
          <td>payment reception date</td>
          <td>${member.payment_received_date}</td>
        </tr>
        <tr>
          <td>payment confirmed?</td><td>${member.payment_confirmed or "No"}</td>
        </tr>
        <tr tal:condition="member.payment_confirmed">
          <td>payment confirmation date</td><td>${member.payment_confirmed_date}</td>
        </tr>
        <tr>
          <td># shares</td>
          <td>
            total: ${member.num_shares}<br />
            ${len(shares)} package(s):
          <div>
            <table>
              <tr tal:repeat="s shares">
                <td>${s.number} shares</td>
                <td style="white-space:nowrap;">
                  <a href="${request.route_url('shares_detail', id=s.id)}">
                    (<small>${s.date_of_acquisition.strftime('%Y-%m-%d')}</small>)
                  </a>
                </td>
              </tr>
            </table>
          </div>

          </td>
        </tr>
      </table>

      <div tal:condition="member.is_member()">
        <h3 id="certificate">Membership Certificate</h3>
        <table class="table table-striped">
          <tr>
            <td>
              Versand Mitgliedsbescheinigungs-E-Mail
              <small>
                Ein Klick hier setzt ein (neues) Token und versendet eine Email mit Link.<br />
                Der Link enthÃ¤lt auch das Token, ohne welches KEIN pdf generiert wird.<br />
                Ausserdem wird Ã¼berprÃ¼ft, ob das Token Ã¤lter ist als 14 Tage; in dem fall gibt es KEIN PDF.
              </small>
            </td>
            <td>
              <a tal:condition="not member.certificate_email"
                 href="${request.route_url('certificate_mail', id=member.id)}"
                 title="certificate not sent yet"
                 class="btn btn-warning">Noch nie.</a>
              <a tal:condition="member.certificate_email"
                 href="${request.route_url('certificate_mail', id=member.id)}"
                 title="gesendet ${member.certificate_email_date.strftime('am %d.%m.%Y um %H:%M')}"
                 class="btn btn-success">gesendet ${member.certificate_email_date.strftime('am %d.%m.%Y um %H:%M')}</a>
              <small>
                Ein Klick hier setzt ein (neues) Token und versendet eine E-Mail mit Link.<br />
                Der Link enthÃ¤lt auch das Token, ohne welches KEIN pdf generiert wird.<br />
                Ausserdem wird Ã¼berprÃ¼ft, ob das Token Ã¤lter ist als 14 Tage; in dem fall gibt es KEIN PDF.
              </small>
            </td>
          </tr>
          <tr>
            <td>PDF generieren (download)</td>
            <td>
              <a href="${request.route_url('certificate_pdf_staff', id=member.id, name=member.get_url_safe_name())}"
                 title="Mitgliedschaftsurkunde ansehen"
                 class="btn btn-success">PDF generieren und laden</a>
            </td>
          </tr>
        </table>
      </div>



      <!--! membership dues -->
      <div tal:condition="member.membership_accepted">

        <div tal:omit-tag="" tal:condition="not member.membership_date > date(2018,5,31) and (member.membership_loss_date is None or member.membership_loss_date >= date(2018,5,1))">
        <a name="dues18_05"></a>
        <h3 id="certificate">Membership Dues 2018-05</h3>
        <table class="table table-striped">
          <tr>
            <td>
              Versand Mitgliedsbeitrags-Email (Rechnung/Aufforderung)<br/>
              <small>
                Ein Klick hier berechnet den Mitgliedsbeitrag,<br/>
                setzt ein (neues) Token und versendet eine Email,<br/>
                bei normalen Mitgliedern mit Link auf die Rechnung.<br/>
                Der versandte Link enthÃ¤lt das Token, ohne welches KEIN pdf generiert wird.
              </small>

            </td>
            <td>
              <a tal:condition="not member.dues18_05_invoice"
                 href="${request.route_url('send_dues18_05_invoice_email', member_id=member.id)}"
                 title="dues invoice not sent yet"
                 class="btn btn-warning">
                Noch nicht berechnet und verschickt. <br/>
                Jetzt berechnen &amp; versenden: Klick!</a>
              <a tal:condition="member.dues18_05_invoice"
                 href="${request.route_url('send_dues18_05_invoice_email', member_id=member.id)}"
                 title="gesendet ${member.dues18_05_invoice_date.strftime('am %d.%m.%Y um %H:%M')}"
                 class="btn btn-success">gesendet ${member.dues18_05_invoice_date.strftime('am %d.%m.%Y um %H:%M')}. Klicken zum wiederholten versenden.</a>
            </td>
          </tr>
          <tr tal:condition="'investing' not in member.membership_type and member.dues18_05_invoice">
            <td>PDF generieren (download)</td>
            <td>
              <a href="${request.route_url('make_dues18_05_invoice_no_pdf',
                       email=member.email,
                       code=member.dues18_05_token,
                       i=str(member.dues18_05_invoice_no).zfill(4))}"
                 title="Mitgliedschaftsbeitragsrechnung ansehen"
                 class="btn btn-success">PDF generieren und laden</a>
            </td>
          </tr>
          <!--! reduction / exemption -->
          <tr tal:condition="'investing' not in member.membership_type and member.dues18_05_invoice">
            <td>ErmÃ¤Ãigung/Erlass<br/>
              <small>
                Hier siehst Du den errechneten Mitgliedsbeitrag.<br/>
                Du kannst im Falle eines Antrags auf ErmÃ¤Ãigung einen neuen Betrag festsetzen -- auch 0 Euro.<br/>
                Daraufhin wird die alte Rechnung storniert.
                Das Mitglied erhÃ¤lt eine E-Mail.<br/>
                Diese enthÃ¤lt Links auf die Storno-Rechnung
                und eine neue geÃ¤nderte Rechnung.
              </small>
            </td>
            <td>
              <table>
                <tr>
                  <td><small>mÃ¼sste zahlen:</small></td>
                  <td>${member.dues18_05_start}</td>
                </tr>
                <tr>
                  <td><small>berechn. Beitrag: &nbsp;</small></td>
                  <td>${member.dues18_05_amount} Euro</td>
                </tr>
                <tr>
                  <td><small>ermÃ¤Ãigter Beitrag: &nbsp;</small></td>
                  <td tal:condition="not member.dues18_05_reduced">
                    kein Antrag gestellt</td>
                  <td tal:condition="member.dues18_05_reduced">
                    ${member.dues18_05_amount_reduced} Euro</td>
                </tr>
              </table>
              <p>

                <form tal:condition="not member.dues18_05_balanced"
                      id="dues18_05_form"
                      class="form-inline"
                      action="${request.route_url('dues18_05_reduction', member_id=member.id)}"
                      method="post">
                    <label>ermÃ¤Ãigen auf:</label>
                    <input type="hidden"
                           name="confirmed"
                           value="no" />
                    <input type="text"
                           class="form-control"
                           title="foo"
                           name="amount"
                           value="" />
                    <input id="dues18_05_reduce_submit"
                           type="submit"
                           name="submit"
                           class="btn btn-primary"
                           value="Reduce Dues" />
                </form>
              </p>
              <p tal:define="messages request.session.pop_flash('dues18_05_message_to_staff')"
                    tal:condition="messages"
                    tal:attributes="class 'alert alert-danger'">
                <span color="red"
                      tal:repeat="message messages">
                  ${message}
                </span><br />
              </p>
              <p>
                see also <a href="${request.route_url('dues18_05_listing')}"
                            class="btn btn-primary">Dues18_05 Invoices Listing</a>
              </p>
            </td>
          </tr>
          <!--! payments for dues -->
          <!--! case one: not paid yet -->
          <tr tal:condition="'investing' not in member.membership_type
                             and member.dues18_05_invoice
                             and not member.dues18_05_paid
                             and not member.dues18_05_balanced">
            <td>Zahlungseingang<br/>
              <small>
                Hier kann der Zahlungseingang mit Datum vermerkt werden.
              </small>
            </td>
            <td>
              <p>
                <form class="form-inline"
                      action="${request.route_url('dues18_05_notice', member_id=member.id)}"
                      method="post">
                  <label>Betrag eingegangen:</label>
                     <input type="text"
                           class="form-control"
                           title="foo"
                           name="amount"
                           value="" />
                     <br />
                     Eingangsdatum (yyyy-mm-dd):
                     <input name="payment_date"
                            class="form-control"
                            type="text"
                            value="${today}" />
                     <br />
                     <input name="submit" type="submit"
                            class="btn btn-primary"
                            value="Zahlungseingang bestÃ¤tigen." />
                </form>
              </p>
              <p tal:define="messages request.session.pop_flash('dues18_05notice_message_to_staff')"
                    tal:condition="messages"
                    tal:attributes="class 'alert alert-danger'">
                <span color="red"
                      tal:repeat="message messages">
                  ${message}
                </span><br />
              </p>
            </td>
          </tr>
          <!-- case two: already paid OR dues exempted-->
          <tr tal:condition="'investing' not in member.membership_type
                             and member.dues18_05_invoice
                             and member.dues18_05_paid
                             or member.dues18_05_balanced">
            <td>Zahlungseingang<br/>
              <small>
                Hier ist der Zahlungseingang mit Datum vermerkt.
              </small>
            </td>
            <td>
              <table class="table table-striped">
                <tr>
                  <td>Betrag eingegangen:</td><td>${member.dues18_05_amount_paid}</td>
                </tr><tr>
                  <td>Eingangsdatum:</td><td>${member.dues18_05_paid_date}</td>
                </tr>
              </table>
            </td>
          </tr>
          <tr tal:condition="'investing' not in member.membership_type and member.dues18_05_invoice">
            <td>Rechnungen<br/>
              <small>
                Hier siehst Du die erstellten Rechnungen fÃ¼r dieses Mitglied.<br/>
                Falls vorhanden in der vorletzten Zeile (Ã¼ber SALDO) auch einen Zahlungseingang.
              </small>
            </td>
            <td>
              <table class="table table-striped" rules="rows">
                <tr class="table-striped">
                  <th>invoice no</th>
                  <th>invoice string<br/>(download PDF)</th>
                  <th>date</th>
                  <th>amount</th>
                  <th>was<br/>reversed?</th>
                  <th>is<br/>reversal?</th>
                  <th>default or<br/>altered?</th>
                </tr>

                <!--! loop over the list of invoices -->
                <tr tal:define="global i_saldo python:0"
                    tal:repeat="i invoices18_05"
                    tal:attributes="id python: 'invoice_{0}'.format(i.id)">
                  <!-- td>${i.id}</td -->
                  <td><a title="${i.invoice_no}">${i.invoice_no}</a></td>
                  <td>
                    <!--! if this invoice is a normal invoice -->
                    <a tal:condition="not i.is_reversal"
                       href="${request.route_url('make_dues18_05_invoice_no_pdf',
                             i=str(i.invoice_no).zfill(4),
                             email=i.email,
                             code=i.token)}"
                       title="download ${i.invoice_no_string}.pdf">
                      ${i.invoice_no_string}
                    </a>
                    <!--! if this invoice is a REVERSAL INVOICE -->
                    <a  tal:condition="i.is_reversal"
                        href="${request.route_url('make_dues18_05_reversal_invoice_pdf',
                              no=str(i.invoice_no).zfill(4),
                              email=i.email,
                              code=i.token)}"
                        title="download ${i.invoice_no_string}-S.pdf">
                      ${i.invoice_no_string}
                    </a>
                  </td>
                  <td>${i.invoice_date.strftime('%d.%m.%Y %H:%M')}</td>
                  <td tal:define="global i_saldo python: D(i_saldo) + D(i.invoice_amount)">
                    ${i.invoice_amount}</td>
                  <td>${'reversed by %s' % i.succeeding_invoice_no if i.is_cancelled else ''}</td>
                  <td>${'reverses %s' % i.preceding_invoice_no if i.is_reversal else ''}</td>
                  <td>${'altered' if i.is_altered else ''}</td>
                </tr>
                <tr tal:condition="member.dues18_05_paid">
                  <td>n/a</td>
                  <td>Zahlungseingang</td>
                  <td>${member.dues18_05_paid_date.strftime('%Y-%m-%d')}</td>
                  <td tal:define="global i_saldo python: D(i_saldo) - D(member.dues18_05_amount_paid)">
                    ${member.dues18_05_amount_paid}</td>
                  <td></td>
                  <td></td>
                  <td></td>
                </tr>
                <tr>
                  <td></td>
                  <td>SALDO: </td>
                  <td></td>
                  <td>${i_saldo}</td>
                  <td></td>
                  <td></td>
                  <td></td>
                </tr>
              </table>
            </td>
          </tr>
        </table>
        </div>


        <div tal:omit-tag="" tal:condition="not member.membership_date > date(2018,6,30) and (member.membership_loss_date is None or member.membership_loss_date >= date(2018,6,1))">
        <a name="dues18_06"></a>
        <h3 id="certificate">Membership Dues 2018_06</h3>
        <table class="table table-striped">
          <tr>
            <td>
              Versand Mitgliedsbeitrags-Email (Rechnung/Aufforderung)<br/>
              <small>
                Ein Klick hier berechnet den Mitgliedsbeitrag,<br/>
                setzt ein (neues) Token und versendet eine Email,<br/>
                bei normalen Mitgliedern mit Link auf die Rechnung.<br/>
                Der versandte Link enthÃ¤lt das Token, ohne welches KEIN pdf generiert wird.
              </small>

            </td>
            <td>
              <a tal:condition="not member.dues18_06_invoice"
                 href="${request.route_url('send_dues18_06_invoice_email', member_id=member.id)}"
                 title="dues invoice not sent yet"
                 class="btn btn-warning">
                Noch nicht berechnet und verschickt. <br/>
                Jetzt berechnen &amp; versenden: Klick!</a>
              <a tal:condition="member.dues18_06_invoice"
                 href="${request.route_url('send_dues18_06_invoice_email', member_id=member.id)}"
                 title="gesendet ${member.dues18_06_invoice_date.strftime('am %d.%m.%Y um %H:%M')}"
                 class="btn btn-success">gesendet ${member.dues18_06_invoice_date.strftime('am %d.%m.%Y um %H:%M')}. Klicken zum wiederholten versenden.</a>
            </td>
          </tr>
          <tr tal:condition="'investing' not in member.membership_type and member.dues18_06_invoice">
            <td>PDF generieren (download)</td>
            <td>
              <a href="${request.route_url('make_dues18_06_invoice_no_pdf',
                       email=member.email,
                       code=member.dues18_06_token,
                       i=str(member.dues18_06_invoice_no).zfill(4))}"
                 title="Mitgliedschaftsbeitragsrechnung ansehen"
                 class="btn btn-success">PDF generieren und laden</a>
            </td>
          </tr>
          <!--! reduction / exemption -->
          <tr tal:condition="'investing' not in member.membership_type and member.dues18_06_invoice">
            <td>ErmÃ¤Ãigung/Erlass<br/>
              <small>
                Hier siehst Du den errechneten Mitgliedsbeitrag.<br/>
                Du kannst im Falle eines Antrags auf ErmÃ¤Ãigung einen neuen Betrag festsetzen -- auch 0 Euro.<br/>
                Daraufhin wird die alte Rechnung storniert.
                Das Mitglied erhÃ¤lt eine E-Mail.<br/>
                Diese enthÃ¤lt Links auf die Storno-Rechnung
                und eine neue geÃ¤nderte Rechnung.
              </small>
            </td>
            <td>
              <table>
                <tr>
                  <td><small>mÃ¼sste zahlen:</small></td>
                  <td>${member.dues18_06_start}</td>
                </tr>
                <tr>
                  <td><small>berechn. Beitrag: &nbsp;</small></td>
                  <td>${member.dues18_06_amount} Euro</td>
                </tr>
                <tr>
                  <td><small>ermÃ¤Ãigter Beitrag: &nbsp;</small></td>
                  <td tal:condition="not member.dues18_06_reduced">
                    kein Antrag gestellt</td>
                  <td tal:condition="member.dues18_06_reduced">
                    ${member.dues18_06_amount_reduced} Euro</td>
                </tr>
              </table>
              <p>

                <form tal:condition="not member.dues18_06_balanced"
                      id="dues18_06_form"
                      class="form-inline"
                      action="${request.route_url('dues18_06_reduction', member_id=member.id)}"
                      method="post">
                    <label>ermÃ¤Ãigen auf:</label>
                    <input type="hidden"
                           name="confirmed"
                           value="no" />
                    <input type="text"
                           class="form-control"
                           title="foo"
                           name="amount"
                           value="" />
                    <input id="dues18_06_reduce_submit"
                           type="submit"
                           name="submit"
                           class="btn btn-primary"
                           value="Reduce Dues" />
                </form>
              </p>
              <p tal:define="messages request.session.pop_flash('dues18_06_message_to_staff')"
                    tal:condition="messages"
                    tal:attributes="class 'alert alert-danger'">
                <span color="red"
                      tal:repeat="message messages">
                  ${message}
                </span><br />
              </p>
              <p>
                see also <a href="${request.route_url('dues18_06_listing')}"
                            class="btn btn-primary">Dues18_06 Invoices Listing</a>
              </p>
            </td>
          </tr>
          <!--! payments for dues -->
          <!--! case one: not paid yet -->
          <tr tal:condition="'investing' not in member.membership_type
                             and member.dues18_06_invoice
                             and not member.dues18_06_paid
                             and not member.dues18_06_balanced">
            <td>Zahlungseingang<br/>
              <small>
                Hier kann der Zahlungseingang mit Datum vermerkt werden.
              </small>
            </td>
            <td>
              <p>
                <form class="form-inline"
                      action="${request.route_url('dues18_06_notice', member_id=member.id)}"
                      method="post">
                  <label>Betrag eingegangen:</label>
                     <input type="text"
                           class="form-control"
                           title="foo"
                           name="amount"
                           value="" />
                     <br />
                     Eingangsdatum (yyyy-mm-dd):
                     <input name="payment_date"
                            class="form-control"
                            type="text"
                            value="${today}" />
                     <br />
                     <input name="submit" type="submit"
                            class="btn btn-primary"
                            value="Zahlungseingang bestÃ¤tigen." />
                </form>
              </p>
              <p tal:define="messages request.session.pop_flash('dues18_06notice_message_to_staff')"
                    tal:condition="messages"
                    tal:attributes="class 'alert alert-danger'">
                <span color="red"
                      tal:repeat="message messages">
                  ${message}
                </span><br />
              </p>
            </td>
          </tr>
          <!-- case two: already paid OR dues exempted-->
          <tr tal:condition="'investing' not in member.membership_type
                             and member.dues18_06_invoice
                             and member.dues18_06_paid
                             or member.dues18_06_balanced">
            <td>Zahlungseingang<br/>
              <small>
                Hier ist der Zahlungseingang mit Datum vermerkt.
              </small>
            </td>
            <td>
              <table class="table table-striped">
                <tr>
                  <td>Betrag eingegangen:</td><td>${member.dues18_06_amount_paid}</td>
                </tr><tr>
                  <td>Eingangsdatum:</td><td>${member.dues18_06_paid_date}</td>
                </tr>
              </table>
            </td>
          </tr>
          <tr tal:condition="'investing' not in member.membership_type and member.dues18_06_invoice">
            <td>Rechnungen<br/>
              <small>
                Hier siehst Du die erstellten Rechnungen fÃ¼r dieses Mitglied.<br/>
                Falls vorhanden in der vorletzten Zeile (Ã¼ber SALDO) auch einen Zahlungseingang.
              </small>
            </td>
            <td>
              <table class="table table-striped" rules="rows">
                <tr class="table-striped">
                  <th>invoice no</th>
                  <th>invoice string<br/>(download PDF)</th>
                  <th>date</th>
                  <th>amount</th>
                  <th>was<br/>reversed?</th>
                  <th>is<br/>reversal?</th>
                  <th>default or<br/>altered?</th>
                </tr>

                <!--! loop over the list of invoices -->
                <tr tal:define="global i_saldo python:0"
                    tal:repeat="i invoices18_06"
                    tal:attributes="id python: 'invoice_{0}'.format(i.id)">
                  <!-- td>${i.id}</td -->
                  <td><a title="${i.invoice_no}">${i.invoice_no}</a></td>
                  <td>
                    <!--! if this invoice is a normal invoice -->
                    <a tal:condition="not i.is_reversal"
                       href="${request.route_url('make_dues18_06_invoice_no_pdf',
                             i=str(i.invoice_no).zfill(4),
                             email=i.email,
                             code=i.token)}"
                       title="download ${i.invoice_no_string}.pdf">
                      ${i.invoice_no_string}
                    </a>
                    <!--! if this invoice is a REVERSAL INVOICE -->
                    <a  tal:condition="i.is_reversal"
                        href="${request.route_url('make_dues18_06_reversal_invoice_pdf',
                              no=str(i.invoice_no).zfill(4),
                              email=i.email,
                              code=i.token)}"
                        title="download ${i.invoice_no_string}-S.pdf">
                      ${i.invoice_no_string}
                    </a>
                  </td>
                  <td>${i.invoice_date.strftime('%d.%m.%Y %H:%M')}</td>
                  <td tal:define="global i_saldo python: D(i_saldo) + D(i.invoice_amount)">
                    ${i.invoice_amount}</td>
                  <td>${'reversed by %s' % i.succeeding_invoice_no if i.is_cancelled else ''}</td>
                  <td>${'reverses %s' % i.preceding_invoice_no if i.is_reversal else ''}</td>
                  <td>${'altered' if i.is_altered else ''}</td>
                </tr>
                <tr tal:condition="member.dues18_06_paid">
                  <td>n/a</td>
                  <td>Zahlungseingang</td>
                  <td>${member.dues18_06_paid_date.strftime('%Y-%m-%d')}</td>
                  <td tal:define="global i_saldo python: D(i_saldo) - D(member.dues18_06_amount_paid)">
                    ${member.dues18_06_amount_paid}</td>
                  <td></td>
                  <td></td>
                  <td></td>
                </tr>
                <tr>
                  <td></td>
                  <td>SALDO: </td>
                  <td></td>
                  <td>${i_saldo}</td>
                  <td></td>
                  <td></td>
                  <td></td>
                </tr>
              </table>
            </td>
          </tr>
        </table>
        </div>


        <div tal:omit-tag="" tal:condition="not member.membership_date > date(2018,7,31) and (member.membership_loss_date is None or member.membership_loss_date >= date(2018,7,1))">
        <a name="dues18_07"></a>
        <h3 id="certificate">Membership Dues 2018_07</h3>
        <table class="table table-striped">
          <tr>
            <td>
              Versand Mitgliedsbeitrags-Email (Rechnung/Aufforderung)<br/>
              <small>
                Ein Klick hier berechnet den Mitgliedsbeitrag,<br/>
                setzt ein (neues) Token und versendet eine Email,<br/>
                bei normalen Mitgliedern mit Link auf die Rechnung.<br/>
                Der versandte Link enthÃ¤lt das Token, ohne welches KEIN pdf generiert wird.
              </small>

            </td>
            <td>
              <a tal:condition="not member.dues18_07_invoice"
                 href="${request.route_url('send_dues18_07_invoice_email', member_id=member.id)}"
                 title="dues invoice not sent yet"
                 class="btn btn-warning">
                Noch nicht berechnet und verschickt. <br/>
                Jetzt berechnen &amp; versenden: Klick!</a>
              <a tal:condition="member.dues18_07_invoice"
                 href="${request.route_url('send_dues18_07_invoice_email', member_id=member.id)}"
                 title="gesendet ${member.dues18_07_invoice_date.strftime('am %d.%m.%Y um %H:%M')}"
                 class="btn btn-success">gesendet ${member.dues18_07_invoice_date.strftime('am %d.%m.%Y um %H:%M')}. Klicken zum wiederholten versenden.</a>
            </td>
          </tr>
          <tr tal:condition="'investing' not in member.membership_type and member.dues18_07_invoice">
            <td>PDF generieren (download)</td>
            <td>
              <a href="${request.route_url('make_dues18_07_invoice_no_pdf',
                       email=member.email,
                       code=member.dues18_07_token,
                       i=str(member.dues18_07_invoice_no).zfill(4))}"
                 title="Mitgliedschaftsbeitragsrechnung ansehen"
                 class="btn btn-success">PDF generieren und laden</a>
            </td>
          </tr>
          <!--! reduction / exemption -->
          <tr tal:condition="'investing' not in member.membership_type and member.dues18_07_invoice">
            <td>ErmÃ¤Ãigung/Erlass<br/>
              <small>
                Hier siehst Du den errechneten Mitgliedsbeitrag.<br/>
                Du kannst im Falle eines Antrags auf ErmÃ¤Ãigung einen neuen Betrag festsetzen -- auch 0 Euro.<br/>
                Daraufhin wird die alte Rechnung storniert.
                Das Mitglied erhÃ¤lt eine E-Mail.<br/>
                Diese enthÃ¤lt Links auf die Storno-Rechnung
                und eine neue geÃ¤nderte Rechnung.
              </small>
            </td>
            <td>
              <table>
                <tr>
                  <td><small>mÃ¼sste zahlen:</small></td>
                  <td>${member.dues18_07_start}</td>
                </tr>
                <tr>
                  <td><small>berechn. Beitrag: &nbsp;</small></td>
                  <td>${member.dues18_07_amount} Euro</td>
                </tr>
                <tr>
                  <td><small>ermÃ¤Ãigter Beitrag: &nbsp;</small></td>
                  <td tal:condition="not member.dues18_07_reduced">
                    kein Antrag gestellt</td>
                  <td tal:condition="member.dues18_07_reduced">
                    ${member.dues18_07_amount_reduced} Euro</td>
                </tr>
              </table>
              <p>

                <form tal:condition="not member.dues18_07_balanced"
                      id="dues18_07_form"
                      class="form-inline"
                      action="${request.route_url('dues18_07_reduction', member_id=member.id)}"
                      method="post">
                    <label>ermÃ¤Ãigen auf:</label>
                    <input type="hidden"
                           name="confirmed"
                           value="no" />
                    <input type="text"
                           class="form-control"
                           title="foo"
                           name="amount"
                           value="" />
                    <input id="dues18_07_reduce_submit"
                           type="submit"
                           name="submit"
                           class="btn btn-primary"
                           value="Reduce Dues" />
                </form>
              </p>
              <p tal:define="messages request.session.pop_flash('dues18_07_message_to_staff')"
                    tal:condition="messages"
                    tal:attributes="class 'alert alert-danger'">
                <span color="red"
                      tal:repeat="message messages">
                  ${message}
                </span><br />
              </p>
              <p>
                see also <a href="${request.route_url('dues18_07_listing')}"
                            class="btn btn-primary">Dues18_07 Invoices Listing</a>
              </p>
            </td>
          </tr>
          <!--! payments for dues -->
          <!--! case one: not paid yet -->
          <tr tal:condition="'investing' not in member.membership_type
                             and member.dues18_07_invoice
                             and not member.dues18_07_paid
                             and not member.dues18_07_balanced">
            <td>Zahlungseingang<br/>
              <small>
                Hier kann der Zahlungseingang mit Datum vermerkt werden.
              </small>
            </td>
            <td>
              <p>
                <form class="form-inline"
                      action="${request.route_url('dues18_07_notice', member_id=member.id)}"
                      method="post">
                  <label>Betrag eingegangen:</label>
                     <input type="text"
                           class="form-control"
                           title="foo"
                           name="amount"
                           value="" />
                     <br />
                     Eingangsdatum (yyyy-mm-dd):
                     <input name="payment_date"
                            class="form-control"
                            type="text"
                            value="${today}" />
                     <br />
                     <input name="submit" type="submit"
                            class="btn btn-primary"
                            value="Zahlungseingang bestÃ¤tigen." />
                </form>
              </p>
              <p tal:define="messages request.session.pop_flash('dues18_07notice_message_to_staff')"
                    tal:condition="messages"
                    tal:attributes="class 'alert alert-danger'">
                <span color="red"
                      tal:repeat="message messages">
                  ${message}
                </span><br />
              </p>
            </td>
          </tr>
          <!-- case two: already paid OR dues exempted-->
          <tr tal:condition="'investing' not in member.membership_type
                             and member.dues18_07_invoice
                             and member.dues18_07_paid
                             or member.dues18_07_balanced">
            <td>Zahlungseingang<br/>
              <small>
                Hier ist der Zahlungseingang mit Datum vermerkt.
              </small>
            </td>
            <td>
              <table class="table table-striped">
                <tr>
                  <td>Betrag eingegangen:</td><td>${member.dues18_07_amount_paid}</td>
                </tr><tr>
                  <td>Eingangsdatum:</td><td>${member.dues18_07_paid_date}</td>
                </tr>
              </table>
            </td>
          </tr>
          <tr tal:condition="'investing' not in member.membership_type and member.dues18_07_invoice">
            <td>Rechnungen<br/>
              <small>
                Hier siehst Du die erstellten Rechnungen fÃ¼r dieses Mitglied.<br/>
                Falls vorhanden in der vorletzten Zeile (Ã¼ber SALDO) auch einen Zahlungseingang.
              </small>
            </td>
            <td>
              <table class="table table-striped" rules="rows">
                <tr class="table-striped">
                  <th>invoice no</th>
                  <th>invoice string<br/>(download PDF)</th>
                  <th>date</th>
                  <th>amount</th>
                  <th>was<br/>reversed?</th>
                  <th>is<br/>reversal?</th>
                  <th>default or<br/>altered?</th>
                </tr>

                <!--! loop over the list of invoices -->
                <tr tal:define="global i_saldo python:0"
                    tal:repeat="i invoices18_07"
                    tal:attributes="id python: 'invoice_{0}'.format(i.id)">
                  <!-- td>${i.id}</td -->
                  <td><a title="${i.invoice_no}">${i.invoice_no}</a></td>
                  <td>
                    <!--! if this invoice is a normal invoice -->
                    <a tal:condition="not i.is_reversal"
                       href="${request.route_url('make_dues18_07_invoice_no_pdf',
                             i=str(i.invoice_no).zfill(4),
                             email=i.email,
                             code=i.token)}"
                       title="download ${i.invoice_no_string}.pdf">
                      ${i.invoice_no_string}
                    </a>
                    <!--! if this invoice is a REVERSAL INVOICE -->
                    <a  tal:condition="i.is_reversal"
                        href="${request.route_url('make_dues18_07_reversal_invoice_pdf',
                              no=str(i.invoice_no).zfill(4),
                              email=i.email,
                              code=i.token)}"
                        title="download ${i.invoice_no_string}-S.pdf">
                      ${i.invoice_no_string}
                    </a>
                  </td>
                  <td>${i.invoice_date.strftime('%d.%m.%Y %H:%M')}</td>
                  <td tal:define="global i_saldo python: D(i_saldo) + D(i.invoice_amount)">
                    ${i.invoice_amount}</td>
                  <td>${'reversed by %s' % i.succeeding_invoice_no if i.is_cancelled else ''}</td>
                  <td>${'reverses %s' % i.preceding_invoice_no if i.is_reversal else ''}</td>
                  <td>${'altered' if i.is_altered else ''}</td>
                </tr>
                <tr tal:condition="member.dues18_07_paid">
                  <td>n/a</td>
                  <td>Zahlungseingang</td>
                  <td>${member.dues18_07_paid_date.strftime('%Y-%m-%d')}</td>
                  <td tal:define="global i_saldo python: D(i_saldo) - D(member.dues18_07_amount_paid)">
                    ${member.dues18_07_amount_paid}</td>
                  <td></td>
                  <td></td>
                  <td></td>
                </tr>
                <tr>
                  <td></td>
                  <td>SALDO: </td>
                  <td></td>
                  <td>${i_saldo}</td>
                  <td></td>
                  <td></td>
                  <td></td>
                </tr>
              </table>
            </td>
          </tr>
        </table>
        </div>

        <div tal:omit-tag="" tal:condition="not member.membership_date > date(2018,8,31) and (member.membership_loss_date is None or member.membership_loss_date >= date(2018,8,1))">
        <a name="dues18_09"></a>
        <h3 id="certificate">Membership Dues 2018_09</h3>
        <table class="table table-striped">
          <tr>
            <td>
              Versand Mitgliedsbeitrags-Email (Rechnung/Aufforderung)<br/>
              <small>
                Ein Klick hier berechnet den Mitgliedsbeitrag,<br/>
                setzt ein (neues) Token und versendet eine Email,<br/>
                bei normalen Mitgliedern mit Link auf die Rechnung.<br/>
                Der versandte Link enthÃ¤lt das Token, ohne welches KEIN pdf generiert wird.
              </small>

            </td>
            <td>
              <a tal:condition="not member.dues18_09_invoice"
                 href="${request.route_url('send_dues18_09_invoice_email', member_id=member.id)}"
                 title="dues invoice not sent yet"
                 class="btn btn-warning">
                Noch nicht berechnet und verschickt. <br/>
                Jetzt berechnen &amp; versenden: Klick!</a>
              <a tal:condition="member.dues18_09_invoice"
                 href="${request.route_url('send_dues18_09_invoice_email', member_id=member.id)}"
                 title="gesendet ${member.dues18_09_invoice_date.strftime('am %d.%m.%Y um %H:%M')}"
                 class="btn btn-success">gesendet ${member.dues18_09_invoice_date.strftime('am %d.%m.%Y um %H:%M')}. Klicken zum wiederholten versenden.</a>
            </td>
          </tr>
          <tr tal:condition="'investing' not in member.membership_type and member.dues18_09_invoice">
            <td>PDF generieren (download)</td>
            <td>
              <a href="${request.route_url('make_dues18_09_invoice_no_pdf',
                       email=member.email,
                       code=member.dues18_09_token,
                       i=str(member.dues18_09_invoice_no).zfill(4))}"
                 title="Mitgliedschaftsbeitragsrechnung ansehen"
                 class="btn btn-success">PDF generieren und laden</a>
            </td>
          </tr>
          <!--! reduction / exemption -->
          <tr tal:condition="'investing' not in member.membership_type and member.dues18_09_invoice">
            <td>ErmÃ¤Ãigung/Erlass<br/>
              <small>
                Hier siehst Du den errechneten Mitgliedsbeitrag.<br/>
                Du kannst im Falle eines Antrags auf ErmÃ¤Ãigung einen neuen Betrag festsetzen -- auch 0 Euro.<br/>
                Daraufhin wird die alte Rechnung storniert.
                Das Mitglied erhÃ¤lt eine E-Mail.<br/>
                Diese enthÃ¤lt Links auf die Storno-Rechnung
                und eine neue geÃ¤nderte Rechnung.
              </small>
            </td>
            <td>
              <table>
                <tr>
                  <td><small>mÃ¼sste zahlen:</small></td>
                  <td>${member.dues18_09_start}</td>
                </tr>
                <tr>
                  <td><small>berechn. Beitrag: &nbsp;</small></td>
                  <td>${member.dues18_09_amount} Euro</td>
                </tr>
                <tr>
                  <td><small>ermÃ¤Ãigter Beitrag: &nbsp;</small></td>
                  <td tal:condition="not member.dues18_09_reduced">
                    kein Antrag gestellt</td>
                  <td tal:condition="member.dues18_09_reduced">
                    ${member.dues18_09_amount_reduced} Euro</td>
                </tr>
              </table>
              <p>

                <form tal:condition="not member.dues18_09_balanced"
                      id="dues18_09_form"
                      class="form-inline"
                      action="${request.route_url('dues18_09_reduction', member_id=member.id)}"
                      method="post">
                    <label>ermÃ¤Ãigen auf:</label>
                    <input type="hidden"
                           name="confirmed"
                           value="no" />
                    <input type="text"
                           class="form-control"
                           title="foo"
                           name="amount"
                           value="" />
                    <input id="dues18_09_reduce_submit"
                           type="submit"
                           name="submit"
                           class="btn btn-primary"
                           value="Reduce Dues" />
                </form>
              </p>
              <p tal:define="messages request.session.pop_flash('dues18_09_message_to_staff')"
                    tal:condition="messages"
                    tal:attributes="class 'alert alert-danger'">
                <span color="red"
                      tal:repeat="message messages">
                  ${message}
                </span><br />
              </p>
              <p>
                see also <a href="${request.route_url('dues18_09_listing')}"
                            class="btn btn-primary">Dues18_09 Invoices Listing</a>
              </p>
            </td>
          </tr>
          <!--! payments for dues -->
          <!--! case one: not paid yet -->
          <tr tal:condition="'investing' not in member.membership_type
                             and member.dues18_09_invoice
                             and not member.dues18_09_paid
                             and not member.dues18_09_balanced">
            <td>Zahlungseingang<br/>
              <small>
                Hier kann der Zahlungseingang mit Datum vermerkt werden.
              </small>
            </td>
            <td>
              <p>
                <form class="form-inline"
                      action="${request.route_url('dues18_09_notice', member_id=member.id)}"
                      method="post">
                  <label>Betrag eingegangen:</label>
                     <input type="text"
                           class="form-control"
                           title="foo"
                           name="amount"
                           value="" />
                     <br />
                     Eingangsdatum (yyyy-mm-dd):
                     <input name="payment_date"
                            class="form-control"
                            type="text"
                            value="${today}" />
                     <br />
                     <input name="submit" type="submit"
                            class="btn btn-primary"
                            value="Zahlungseingang bestÃ¤tigen." />
                </form>
              </p>
              <p tal:define="messages request.session.pop_flash('dues18_09notice_message_to_staff')"
                    tal:condition="messages"
                    tal:attributes="class 'alert alert-danger'">
                <span color="red"
                      tal:repeat="message messages">
                  ${message}
                </span><br />
              </p>
            </td>
          </tr>
          <!-- case two: already paid OR dues exempted-->
          <tr tal:condition="'investing' not in member.membership_type
                             and member.dues18_09_invoice
                             and member.dues18_09_paid
                             or member.dues18_09_balanced">
            <td>Zahlungseingang<br/>
              <small>
                Hier ist der Zahlungseingang mit Datum vermerkt.
              </small>
            </td>
            <td>
              <table class="table table-striped">
                <tr>
                  <td>Betrag eingegangen:</td><td>${member.dues18_09_amount_paid}</td>
                </tr><tr>
                  <td>Eingangsdatum:</td><td>${member.dues18_09_paid_date}</td>
                </tr>
              </table>
            </td>
          </tr>
          <tr tal:condition="'investing' not in member.membership_type and member.dues18_09_invoice">
            <td>Rechnungen<br/>
              <small>
                Hier siehst Du die erstellten Rechnungen fÃ¼r dieses Mitglied.<br/>
                Falls vorhanden in der vorletzten Zeile (Ã¼ber SALDO) auch einen Zahlungseingang.
              </small>
            </td>
            <td>
              <table class="table table-striped" rules="rows">
                <tr class="table-striped">
                  <th>invoice no</th>
                  <th>invoice string<br/>(download PDF)</th>
                  <th>date</th>
                  <th>amount</th>
                  <th>was<br/>reversed?</th>
                  <th>is<br/>reversal?</th>
                  <th>default or<br/>altered?</th>
                </tr>

                <!--! loop over the list of invoices -->
                <tr tal:define="global i_saldo python:0"
                    tal:repeat="i invoices18_09"
                    tal:attributes="id python: 'invoice_{0}'.format(i.id)">
                  <!-- td>${i.id}</td -->
                  <td><a title="${i.invoice_no}">${i.invoice_no}</a></td>
                  <td>
                    <!--! if this invoice is a normal invoice -->
                    <a tal:condition="not i.is_reversal"
                       href="${request.route_url('make_dues18_09_invoice_no_pdf',
                             i=str(i.invoice_no).zfill(4),
                             email=i.email,
                             code=i.token)}"
                       title="download ${i.invoice_no_string}.pdf">
                      ${i.invoice_no_string}
                    </a>
                    <!--! if this invoice is a REVERSAL INVOICE -->
                    <a  tal:condition="i.is_reversal"
                        href="${request.route_url('make_dues18_09_reversal_invoice_pdf',
                              no=str(i.invoice_no).zfill(4),
                              email=i.email,
                              code=i.token)}"
                        title="download ${i.invoice_no_string}-S.pdf">
                      ${i.invoice_no_string}
                    </a>
                  </td>
                  <td>${i.invoice_date.strftime('%d.%m.%Y %H:%M')}</td>
                  <td tal:define="global i_saldo python: D(i_saldo) + D(i.invoice_amount)">
                    ${i.invoice_amount}</td>
                  <td>${'reversed by %s' % i.succeeding_invoice_no if i.is_cancelled else ''}</td>
                  <td>${'reverses %s' % i.preceding_invoice_no if i.is_reversal else ''}</td>
                  <td>${'altered' if i.is_altered else ''}</td>
                </tr>
                <tr tal:condition="member.dues18_09_paid">
                  <td>n/a</td>
                  <td>Zahlungseingang</td>
                  <td>${member.dues18_09_paid_date.strftime('%Y-%m-%d')}</td>
                  <td tal:define="global i_saldo python: D(i_saldo) - D(member.dues18_09_amount_paid)">
                    ${member.dues18_09_amount_paid}</td>
                  <td></td>
                  <td></td>
                  <td></td>
                </tr>
                <tr>
                  <td></td>
                  <td>SALDO: </td>
                  <td></td>
                  <td>${i_saldo}</td>
                  <td></td>
                  <td></td>
                  <td></td>
                </tr>
              </table>
            </td>
          </tr>
        </table>
        </div>

        <div tal:omit-tag="" tal:condition="not member.membership_date > date(2018,9,30) and (member.membership_loss_date is None or member.membership_loss_date >= date(2018,9,1))">
        <a name="dues18_09"></a>
        <h3 id="certificate">Membership Dues 2018_09</h3>
        <table class="table table-striped">
          <tr>
            <td>
              Versand Mitgliedsbeitrags-Email (Rechnung/Aufforderung)<br/>
              <small>
                Ein Klick hier berechnet den Mitgliedsbeitrag,<br/>
                setzt ein (neues) Token und versendet eine Email,<br/>
                bei normalen Mitgliedern mit Link auf die Rechnung.<br/>
                Der versandte Link enthÃ¤lt das Token, ohne welches KEIN pdf generiert wird.
              </small>

            </td>
            <td>
              <a tal:condition="not member.dues18_09_invoice"
                 href="${request.route_url('send_dues18_09_invoice_email', member_id=member.id)}"
                 title="dues invoice not sent yet"
                 class="btn btn-warning">
                Noch nicht berechnet und verschickt. <br/>
                Jetzt berechnen &amp; versenden: Klick!</a>
              <a tal:condition="member.dues18_09_invoice"
                 href="${request.route_url('send_dues18_09_invoice_email', member_id=member.id)}"
                 title="gesendet ${member.dues18_09_invoice_date.strftime('am %d.%m.%Y um %H:%M')}"
                 class="btn btn-success">gesendet ${member.dues18_09_invoice_date.strftime('am %d.%m.%Y um %H:%M')}. Klicken zum wiederholten versenden.</a>
            </td>
          </tr>
          <tr tal:condition="'investing' not in member.membership_type and member.dues18_09_invoice">
            <td>PDF generieren (download)</td>
            <td>
              <a href="${request.route_url('make_dues18_09_invoice_no_pdf',
                       email=member.email,
                       code=member.dues18_09_token,
                       i=str(member.dues18_09_invoice_no).zfill(4))}"
                 title="Mitgliedschaftsbeitragsrechnung ansehen"
                 class="btn btn-success">PDF generieren und laden</a>
            </td>
          </tr>
          <!--! reduction / exemption -->
          <tr tal:condition="'investing' not in member.membership_type and member.dues18_09_invoice">
            <td>ErmÃ¤Ãigung/Erlass<br/>
              <small>
                Hier siehst Du den errechneten Mitgliedsbeitrag.<br/>
                Du kannst im Falle eines Antrags auf ErmÃ¤Ãigung einen neuen Betrag festsetzen -- auch 0 Euro.<br/>
                Daraufhin wird die alte Rechnung storniert.
                Das Mitglied erhÃ¤lt eine E-Mail.<br/>
                Diese enthÃ¤lt Links auf die Storno-Rechnung
                und eine neue geÃ¤nderte Rechnung.
              </small>
            </td>
            <td>
              <table>
                <tr>
                  <td><small>mÃ¼sste zahlen:</small></td>
                  <td>${member.dues18_09_start}</td>
                </tr>
                <tr>
                  <td><small>berechn. Beitrag: &nbsp;</small></td>
                  <td>${member.dues18_09_amount} Euro</td>
                </tr>
                <tr>
                  <td><small>ermÃ¤Ãigter Beitrag: &nbsp;</small></td>
                  <td tal:condition="not member.dues18_09_reduced">
                    kein Antrag gestellt</td>
                  <td tal:condition="member.dues18_09_reduced">
                    ${member.dues18_09_amount_reduced} Euro</td>
                </tr>
              </table>
              <p>

                <form tal:condition="not member.dues18_09_balanced"
                      id="dues18_09_form"
                      class="form-inline"
                      action="${request.route_url('dues18_09_reduction', member_id=member.id)}"
                      method="post">
                    <label>ermÃ¤Ãigen auf:</label>
                    <input type="hidden"
                           name="confirmed"
                           value="no" />
                    <input type="text"
                           class="form-control"
                           title="foo"
                           name="amount"
                           value="" />
                    <input id="dues18_09_reduce_submit"
                           type="submit"
                           name="submit"
                           class="btn btn-primary"
                           value="Reduce Dues" />
                </form>
              </p>
              <p tal:define="messages request.session.pop_flash('dues18_09_message_to_staff')"
                    tal:condition="messages"
                    tal:attributes="class 'alert alert-danger'">
                <span color="red"
                      tal:repeat="message messages">
                  ${message}
                </span><br />
              </p>
              <p>
                see also <a href="${request.route_url('dues18_09_listing')}"
                            class="btn btn-primary">Dues18_09 Invoices Listing</a>
              </p>
            </td>
          </tr>
          <!--! payments for dues -->
          <!--! case one: not paid yet -->
          <tr tal:condition="'investing' not in member.membership_type
                             and member.dues18_09_invoice
                             and not member.dues18_09_paid
                             and not member.dues18_09_balanced">
            <td>Zahlungseingang<br/>
              <small>
                Hier kann der Zahlungseingang mit Datum vermerkt werden.
              </small>
            </td>
            <td>
              <p>
                <form class="form-inline"
                      action="${request.route_url('dues18_09_notice', member_id=member.id)}"
                      method="post">
                  <label>Betrag eingegangen:</label>
                     <input type="text"
                           class="form-control"
                           title="foo"
                           name="amount"
                           value="" />
                     <br />
                     Eingangsdatum (yyyy-mm-dd):
                     <input name="payment_date"
                            class="form-control"
                            type="text"
                            value="${today}" />
                     <br />
                     <input name="submit" type="submit"
                            class="btn btn-primary"
                            value="Zahlungseingang bestÃ¤tigen." />
                </form>
              </p>
              <p tal:define="messages request.session.pop_flash('dues18_09notice_message_to_staff')"
                    tal:condition="messages"
                    tal:attributes="class 'alert alert-danger'">
                <span color="red"
                      tal:repeat="message messages">
                  ${message}
                </span><br />
              </p>
            </td>
          </tr>
          <!-- case two: already paid OR dues exempted-->
          <tr tal:condition="'investing' not in member.membership_type
                             and member.dues18_09_invoice
                             and member.dues18_09_paid
                             or member.dues18_09_balanced">
            <td>Zahlungseingang<br/>
              <small>
                Hier ist der Zahlungseingang mit Datum vermerkt.
              </small>
            </td>
            <td>
              <table class="table table-striped">
                <tr>
                  <td>Betrag eingegangen:</td><td>${member.dues18_09_amount_paid}</td>
                </tr><tr>
                  <td>Eingangsdatum:</td><td>${member.dues18_09_paid_date}</td>
                </tr>
              </table>
            </td>
          </tr>
          <tr tal:condition="'investing' not in member.membership_type and member.dues18_09_invoice">
            <td>Rechnungen<br/>
              <small>
                Hier siehst Du die erstellten Rechnungen fÃ¼r dieses Mitglied.<br/>
                Falls vorhanden in der vorletzten Zeile (Ã¼ber SALDO) auch einen Zahlungseingang.
              </small>
            </td>
            <td>
              <table class="table table-striped" rules="rows">
                <tr class="table-striped">
                  <th>invoice no</th>
                  <th>invoice string<br/>(download PDF)</th>
                  <th>date</th>
                  <th>amount</th>
                  <th>was<br/>reversed?</th>
                  <th>is<br/>reversal?</th>
                  <th>default or<br/>altered?</th>
                </tr>

                <!--! loop over the list of invoices -->
                <tr tal:define="global i_saldo python:0"
                    tal:repeat="i invoices18_09"
                    tal:attributes="id python: 'invoice_{0}'.format(i.id)">
                  <!-- td>${i.id}</td -->
                  <td><a title="${i.invoice_no}">${i.invoice_no}</a></td>
                  <td>
                    <!--! if this invoice is a normal invoice -->
                    <a tal:condition="not i.is_reversal"
                       href="${request.route_url('make_dues18_09_invoice_no_pdf',
                             i=str(i.invoice_no).zfill(4),
                             email=i.email,
                             code=i.token)}"
                       title="download ${i.invoice_no_string}.pdf">
                      ${i.invoice_no_string}
                    </a>
                    <!--! if this invoice is a REVERSAL INVOICE -->
                    <a  tal:condition="i.is_reversal"
                        href="${request.route_url('make_dues18_09_reversal_invoice_pdf',
                              no=str(i.invoice_no).zfill(4),
                              email=i.email,
                              code=i.token)}"
                        title="download ${i.invoice_no_string}-S.pdf">
                      ${i.invoice_no_string}
                    </a>
                  </td>
                  <td>${i.invoice_date.strftime('%d.%m.%Y %H:%M')}</td>
                  <td tal:define="global i_saldo python: D(i_saldo) + D(i.invoice_amount)">
                    ${i.invoice_amount}</td>
                  <td>${'reversed by %s' % i.succeeding_invoice_no if i.is_cancelled else ''}</td>
                  <td>${'reverses %s' % i.preceding_invoice_no if i.is_reversal else ''}</td>
                  <td>${'altered' if i.is_altered else ''}</td>
                </tr>
                <tr tal:condition="member.dues18_09_paid">
                  <td>n/a</td>
                  <td>Zahlungseingang</td>
                  <td>${member.dues18_09_paid_date.strftime('%Y-%m-%d')}</td>
                  <td tal:define="global i_saldo python: D(i_saldo) - D(member.dues18_09_amount_paid)">
                    ${member.dues18_09_amount_paid}</td>
                  <td></td>
                  <td></td>
                  <td></td>
                </tr>
                <tr>
                  <td></td>
                  <td>SALDO: </td>
                  <td></td>
                  <td>${i_saldo}</td>
                  <td></td>
                  <td></td>
                  <td></td>
                </tr>
              </table>
            </td>
          </tr>
        </table>
        </div>

        <div tal:omit-tag="" tal:condition="not member.membership_date > date(2018,10,31) and (member.membership_loss_date is None or member.membership_loss_date >= date(2018,10,1))">
        <a name="dues18_10"></a>
        <h3 id="certificate">Membership Dues 2018_10</h3>
        <table class="table table-striped">
          <tr>
            <td>
              Versand Mitgliedsbeitrags-Email (Rechnung/Aufforderung)<br/>
              <small>
                Ein Klick hier berechnet den Mitgliedsbeitrag,<br/>
                setzt ein (neues) Token und versendet eine Email,<br/>
                bei normalen Mitgliedern mit Link auf die Rechnung.<br/>
                Der versandte Link enthÃ¤lt das Token, ohne welches KEIN pdf generiert wird.
              </small>

            </td>
            <td>
              <a tal:condition="not member.dues18_10_invoice"
                 href="${request.route_url('send_dues18_10_invoice_email', member_id=member.id)}"
                 title="dues invoice not sent yet"
                 class="btn btn-warning">
                Noch nicht berechnet und verschickt. <br/>
                Jetzt berechnen &amp; versenden: Klick!</a>
              <a tal:condition="member.dues18_10_invoice"
                 href="${request.route_url('send_dues18_10_invoice_email', member_id=member.id)}"
                 title="gesendet ${member.dues18_10_invoice_date.strftime('am %d.%m.%Y um %H:%M')}"
                 class="btn btn-success">gesendet ${member.dues18_10_invoice_date.strftime('am %d.%m.%Y um %H:%M')}. Klicken zum wiederholten versenden.</a>
            </td>
          </tr>
          <tr tal:condition="'investing' not in member.membership_type and member.dues18_10_invoice">
            <td>PDF generieren (download)</td>
            <td>
              <a href="${request.route_url('make_dues18_10_invoice_no_pdf',
                       email=member.email,
                       code=member.dues18_10_token,
                       i=str(member.dues18_10_invoice_no).zfill(4))}"
                 title="Mitgliedschaftsbeitragsrechnung ansehen"
                 class="btn btn-success">PDF generieren und laden</a>
            </td>
          </tr>
          <!--! reduction / exemption -->
          <tr tal:condition="'investing' not in member.membership_type and member.dues18_10_invoice">
            <td>ErmÃ¤Ãigung/Erlass<br/>
              <small>
                Hier siehst Du den errechneten Mitgliedsbeitrag.<br/>
                Du kannst im Falle eines Antrags auf ErmÃ¤Ãigung einen neuen Betrag festsetzen -- auch 0 Euro.<br/>
                Daraufhin wird die alte Rechnung storniert.
                Das Mitglied erhÃ¤lt eine E-Mail.<br/>
                Diese enthÃ¤lt Links auf die Storno-Rechnung
                und eine neue geÃ¤nderte Rechnung.
              </small>
            </td>
            <td>
              <table>
                <tr>
                  <td><small>mÃ¼sste zahlen:</small></td>
                  <td>${member.dues18_10_start}</td>
                </tr>
                <tr>
                  <td><small>berechn. Beitrag: &nbsp;</small></td>
                  <td>${member.dues18_10_amount} Euro</td>
                </tr>
                <tr>
                  <td><small>ermÃ¤Ãigter Beitrag: &nbsp;</small></td>
                  <td tal:condition="not member.dues18_10_reduced">
                    kein Antrag gestellt</td>
                  <td tal:condition="member.dues18_10_reduced">
                    ${member.dues18_10_amount_reduced} Euro</td>
                </tr>
              </table>
              <p>

                <form tal:condition="not member.dues18_10_balanced"
                      id="dues18_10_form"
                      class="form-inline"
                      action="${request.route_url('dues18_10_reduction', member_id=member.id)}"
                      method="post">
                    <label>ermÃ¤Ãigen auf:</label>
                    <input type="hidden"
                           name="confirmed"
                           value="no" />
                    <input type="text"
                           class="form-control"
                           title="foo"
                           name="amount"
                           value="" />
                    <input id="dues18_10_reduce_submit"
                           type="submit"
                           name="submit"
                           class="btn btn-primary"
                           value="Reduce Dues" />
                </form>
              </p>
              <p tal:define="messages request.session.pop_flash('dues18_10_message_to_staff')"
                    tal:condition="messages"
                    tal:attributes="class 'alert alert-danger'">
                <span color="red"
                      tal:repeat="message messages">
                  ${message}
                </span><br />
              </p>
              <p>
                see also <a href="${request.route_url('dues18_10_listing')}"
                            class="btn btn-primary">Dues18_10 Invoices Listing</a>
              </p>
            </td>
          </tr>
          <!--! payments for dues -->
          <!--! case one: not paid yet -->
          <tr tal:condition="'investing' not in member.membership_type
                             and member.dues18_10_invoice
                             and not member.dues18_10_paid
                             and not member.dues18_10_balanced">
            <td>Zahlungseingang<br/>
              <small>
                Hier kann der Zahlungseingang mit Datum vermerkt werden.
              </small>
            </td>
            <td>
              <p>
                <form class="form-inline"
                      action="${request.route_url('dues18_10_notice', member_id=member.id)}"
                      method="post">
                  <label>Betrag eingegangen:</label>
                     <input type="text"
                           class="form-control"
                           title="foo"
                           name="amount"
                           value="" />
                     <br />
                     Eingangsdatum (yyyy-mm-dd):
                     <input name="payment_date"
                            class="form-control"
                            type="text"
                            value="${today}" />
                     <br />
                     <input name="submit" type="submit"
                            class="btn btn-primary"
                            value="Zahlungseingang bestÃ¤tigen." />
                </form>
              </p>
              <p tal:define="messages request.session.pop_flash('dues18_10notice_message_to_staff')"
                    tal:condition="messages"
                    tal:attributes="class 'alert alert-danger'">
                <span color="red"
                      tal:repeat="message messages">
                  ${message}
                </span><br />
              </p>
            </td>
          </tr>
          <!-- case two: already paid OR dues exempted-->
          <tr tal:condition="'investing' not in member.membership_type
                             and member.dues18_10_invoice
                             and member.dues18_10_paid
                             or member.dues18_10_balanced">
            <td>Zahlungseingang<br/>
              <small>
                Hier ist der Zahlungseingang mit Datum vermerkt.
              </small>
            </td>
            <td>
              <table class="table table-striped">
                <tr>
                  <td>Betrag eingegangen:</td><td>${member.dues18_10_amount_paid}</td>
                </tr><tr>
                  <td>Eingangsdatum:</td><td>${member.dues18_10_paid_date}</td>
                </tr>
              </table>
            </td>
          </tr>
          <tr tal:condition="'investing' not in member.membership_type and member.dues18_10_invoice">
            <td>Rechnungen<br/>
              <small>
                Hier siehst Du die erstellten Rechnungen fÃ¼r dieses Mitglied.<br/>
                Falls vorhanden in der vorletzten Zeile (Ã¼ber SALDO) auch einen Zahlungseingang.
              </small>
            </td>
            <td>
              <table class="table table-striped" rules="rows">
                <tr class="table-striped">
                  <th>invoice no</th>
                  <th>invoice string<br/>(download PDF)</th>
                  <th>date</th>
                  <th>amount</th>
                  <th>was<br/>reversed?</th>
                  <th>is<br/>reversal?</th>
                  <th>default or<br/>altered?</th>
                </tr>

                <!--! loop over the list of invoices -->
                <tr tal:define="global i_saldo python:0"
                    tal:repeat="i invoices18_10"
                    tal:attributes="id python: 'invoice_{0}'.format(i.id)">
                  <!-- td>${i.id}</td -->
                  <td><a title="${i.invoice_no}">${i.invoice_no}</a></td>
                  <td>
                    <!--! if this invoice is a normal invoice -->
                    <a tal:condition="not i.is_reversal"
                       href="${request.route_url('make_dues18_10_invoice_no_pdf',
                             i=str(i.invoice_no).zfill(4),
                             email=i.email,
                             code=i.token)}"
                       title="download ${i.invoice_no_string}.pdf">
                      ${i.invoice_no_string}
                    </a>
                    <!--! if this invoice is a REVERSAL INVOICE -->
                    <a  tal:condition="i.is_reversal"
                        href="${request.route_url('make_dues18_10_reversal_invoice_pdf',
                              no=str(i.invoice_no).zfill(4),
                              email=i.email,
                              code=i.token)}"
                        title="download ${i.invoice_no_string}-S.pdf">
                      ${i.invoice_no_string}
                    </a>
                  </td>
                  <td>${i.invoice_date.strftime('%d.%m.%Y %H:%M')}</td>
                  <td tal:define="global i_saldo python: D(i_saldo) + D(i.invoice_amount)">
                    ${i.invoice_amount}</td>
                  <td>${'reversed by %s' % i.succeeding_invoice_no if i.is_cancelled else ''}</td>
                  <td>${'reverses %s' % i.preceding_invoice_no if i.is_reversal else ''}</td>
                  <td>${'altered' if i.is_altered else ''}</td>
                </tr>
                <tr tal:condition="member.dues18_10_paid">
                  <td>n/a</td>
                  <td>Zahlungseingang</td>
                  <td>${member.dues18_10_paid_date.strftime('%Y-%m-%d')}</td>
                  <td tal:define="global i_saldo python: D(i_saldo) - D(member.dues18_10_amount_paid)">
                    ${member.dues18_10_amount_paid}</td>
                  <td></td>
                  <td></td>
                  <td></td>
                </tr>
                <tr>
                  <td></td>
                  <td>SALDO: </td>
                  <td></td>
                  <td>${i_saldo}</td>
                  <td></td>
                  <td></td>
                  <td></td>
                </tr>
              </table>
            </td>
          </tr>
        </table>
        </div>

        <div tal:omit-tag="" tal:condition="not member.membership_date > date(2018,11,31) and (member.membership_loss_date is None or member.membership_loss_date >= date(2018,11,1))">
        <a name="dues18_11"></a>
        <h3 id="certificate">Membership Dues 2018_11</h3>
        <table class="table table-striped">
          <tr>
            <td>
              Versand Mitgliedsbeitrags-Email (Rechnung/Aufforderung)<br/>
              <small>
                Ein Klick hier berechnet den Mitgliedsbeitrag,<br/>
                setzt ein (neues) Token und versendet eine Email,<br/>
                bei normalen Mitgliedern mit Link auf die Rechnung.<br/>
                Der versandte Link enthÃ¤lt das Token, ohne welches KEIN pdf generiert wird.
              </small>

            </td>
            <td>
              <a tal:condition="not member.dues18_11_invoice"
                 href="${request.route_url('send_dues18_11_invoice_email', member_id=member.id)}"
                 title="dues invoice not sent yet"
                 class="btn btn-warning">
                Noch nicht berechnet und verschickt. <br/>
                Jetzt berechnen &amp; versenden: Klick!</a>
              <a tal:condition="member.dues18_11_invoice"
                 href="${request.route_url('send_dues18_11_invoice_email', member_id=member.id)}"
                 title="gesendet ${member.dues18_11_invoice_date.strftime('am %d.%m.%Y um %H:%M')}"
                 class="btn btn-success">gesendet ${member.dues18_11_invoice_date.strftime('am %d.%m.%Y um %H:%M')}. Klicken zum wiederholten versenden.</a>
            </td>
          </tr>
          <tr tal:condition="'investing' not in member.membership_type and member.dues18_11_invoice">
            <td>PDF generieren (download)</td>
            <td>
              <a href="${request.route_url('make_dues18_11_invoice_no_pdf',
                       email=member.email,
                       code=member.dues18_11_token,
                       i=str(member.dues18_11_invoice_no).zfill(4))}"
                 title="Mitgliedschaftsbeitragsrechnung ansehen"
                 class="btn btn-success">PDF generieren und laden</a>
            </td>
          </tr>
          <!--! reduction / exemption -->
          <tr tal:condition="'investing' not in member.membership_type and member.dues18_11_invoice">
            <td>ErmÃ¤Ãigung/Erlass<br/>
              <small>
                Hier siehst Du den errechneten Mitgliedsbeitrag.<br/>
                Du kannst im Falle eines Antrags auf ErmÃ¤Ãigung einen neuen Betrag festsetzen -- auch 0 Euro.<br/>
                Daraufhin wird die alte Rechnung storniert.
                Das Mitglied erhÃ¤lt eine E-Mail.<br/>
                Diese enthÃ¤lt Links auf die Storno-Rechnung
                und eine neue geÃ¤nderte Rechnung.
              </small>
            </td>
            <td>
              <table>
                <tr>
                  <td><small>mÃ¼sste zahlen:</small></td>
                  <td>${member.dues18_11_start}</td>
                </tr>
                <tr>
                  <td><small>berechn. Beitrag: &nbsp;</small></td>
                  <td>${member.dues18_11_amount} Euro</td>
                </tr>
                <tr>
                  <td><small>ermÃ¤Ãigter Beitrag: &nbsp;</small></td>
                  <td tal:condition="not member.dues18_11_reduced">
                    kein Antrag gestellt</td>
                  <td tal:condition="member.dues18_11_reduced">
                    ${member.dues18_11_amount_reduced} Euro</td>
                </tr>
              </table>
              <p>

                <form tal:condition="not member.dues18_11_balanced"
                      id="dues18_11_form"
                      class="form-inline"
                      action="${request.route_url('dues18_11_reduction', member_id=member.id)}"
                      method="post">
                    <label>ermÃ¤Ãigen auf:</label>
                    <input type="hidden"
                           name="confirmed"
                           value="no" />
                    <input type="text"
                           class="form-control"
                           title="foo"
                           name="amount"
                           value="" />
                    <input id="dues18_11_reduce_submit"
                           type="submit"
                           name="submit"
                           class="btn btn-primary"
                           value="Reduce Dues" />
                </form>
              </p>
              <p tal:define="messages request.session.pop_flash('dues18_11_message_to_staff')"
                    tal:condition="messages"
                    tal:attributes="class 'alert alert-danger'">
                <span color="red"
                      tal:repeat="message messages">
                  ${message}
                </span><br />
              </p>
              <p>
                see also <a href="${request.route_url('dues18_11_listing')}"
                            class="btn btn-primary">Dues18_11 Invoices Listing</a>
              </p>
            </td>
          </tr>
          <!--! payments for dues -->
          <!--! case one: not paid yet -->
          <tr tal:condition="'investing' not in member.membership_type
                             and member.dues18_11_invoice
                             and not member.dues18_11_paid
                             and not member.dues18_11_balanced">
            <td>Zahlungseingang<br/>
              <small>
                Hier kann der Zahlungseingang mit Datum vermerkt werden.
              </small>
            </td>
            <td>
              <p>
                <form class="form-inline"
                      action="${request.route_url('dues18_11_notice', member_id=member.id)}"
                      method="post">
                  <label>Betrag eingegangen:</label>
                     <input type="text"
                           class="form-control"
                           title="foo"
                           name="amount"
                           value="" />
                     <br />
                     Eingangsdatum (yyyy-mm-dd):
                     <input name="payment_date"
                            class="form-control"
                            type="text"
                            value="${today}" />
                     <br />
                     <input name="submit" type="submit"
                            class="btn btn-primary"
                            value="Zahlungseingang bestÃ¤tigen." />
                </form>
              </p>
              <p tal:define="messages request.session.pop_flash('dues18_11notice_message_to_staff')"
                    tal:condition="messages"
                    tal:attributes="class 'alert alert-danger'">
                <span color="red"
                      tal:repeat="message messages">
                  ${message}
                </span><br />
              </p>
            </td>
          </tr>
          <!-- case two: already paid OR dues exempted-->
          <tr tal:condition="'investing' not in member.membership_type
                             and member.dues18_11_invoice
                             and member.dues18_11_paid
                             or member.dues18_11_balanced">
            <td>Zahlungseingang<br/>
              <small>
                Hier ist der Zahlungseingang mit Datum vermerkt.
              </small>
            </td>
            <td>
              <table class="table table-striped">
                <tr>
                  <td>Betrag eingegangen:</td><td>${member.dues18_11_amount_paid}</td>
                </tr><tr>
                  <td>Eingangsdatum:</td><td>${member.dues18_11_paid_date}</td>
                </tr>
              </table>
            </td>
          </tr>
          <tr tal:condition="'investing' not in member.membership_type and member.dues18_11_invoice">
            <td>Rechnungen<br/>
              <small>
                Hier siehst Du die erstellten Rechnungen fÃ¼r dieses Mitglied.<br/>
                Falls vorhanden in der vorletzten Zeile (Ã¼ber SALDO) auch einen Zahlungseingang.
              </small>
            </td>
            <td>
              <table class="table table-striped" rules="rows">
                <tr class="table-striped">
                  <th>invoice no</th>
                  <th>invoice string<br/>(download PDF)</th>
                  <th>date</th>
                  <th>amount</th>
                  <th>was<br/>reversed?</th>
                  <th>is<br/>reversal?</th>
                  <th>default or<br/>altered?</th>
                </tr>

                <!--! loop over the list of invoices -->
                <tr tal:define="global i_saldo python:0"
                    tal:repeat="i invoices18_11"
                    tal:attributes="id python: 'invoice_{0}'.format(i.id)">
                  <!-- td>${i.id}</td -->
                  <td><a title="${i.invoice_no}">${i.invoice_no}</a></td>
                  <td>
                    <!--! if this invoice is a normal invoice -->
                    <a tal:condition="not i.is_reversal"
                       href="${request.route_url('make_dues18_11_invoice_no_pdf',
                             i=str(i.invoice_no).zfill(4),
                             email=i.email,
                             code=i.token)}"
                       title="download ${i.invoice_no_string}.pdf">
                      ${i.invoice_no_string}
                    </a>
                    <!--! if this invoice is a REVERSAL INVOICE -->
                    <a  tal:condition="i.is_reversal"
                        href="${request.route_url('make_dues18_11_reversal_invoice_pdf',
                              no=str(i.invoice_no).zfill(4),
                              email=i.email,
                              code=i.token)}"
                        title="download ${i.invoice_no_string}-S.pdf">
                      ${i.invoice_no_string}
                    </a>
                  </td>
                  <td>${i.invoice_date.strftime('%d.%m.%Y %H:%M')}</td>
                  <td tal:define="global i_saldo python: D(i_saldo) + D(i.invoice_amount)">
                    ${i.invoice_amount}</td>
                  <td>${'reversed by %s' % i.succeeding_invoice_no if i.is_cancelled else ''}</td>
                  <td>${'reverses %s' % i.preceding_invoice_no if i.is_reversal else ''}</td>
                  <td>${'altered' if i.is_altered else ''}</td>
                </tr>
                <tr tal:condition="member.dues18_11_paid">
                  <td>n/a</td>
                  <td>Zahlungseingang</td>
                  <td>${member.dues18_11_paid_date.strftime('%Y-%m-%d')}</td>
                  <td tal:define="global i_saldo python: D(i_saldo) - D(member.dues18_11_amount_paid)">
                    ${member.dues18_11_amount_paid}</td>
                  <td></td>
                  <td></td>
                  <td></td>
                </tr>
                <tr>
                  <td></td>
                  <td>SALDO: </td>
                  <td></td>
                  <td>${i_saldo}</td>
                  <td></td>
                  <td></td>
                  <td></td>
                </tr>
              </table>
            </td>
          </tr>
        </table>
        </div>

        <div tal:omit-tag="" tal:condition="not member.membership_date > date(2018,12,31) and (member.membership_loss_date is None or member.membership_loss_date >= date(2018,12,1))">
        <a name="dues18_12"></a>
        <h3 id="certificate">Membership Dues 2018_12</h3>
        <table class="table table-striped">
          <tr>
            <td>
              Versand Mitgliedsbeitrags-Email (Rechnung/Aufforderung)<br/>
              <small>
                Ein Klick hier berechnet den Mitgliedsbeitrag,<br/>
                setzt ein (neues) Token und versendet eine Email,<br/>
                bei normalen Mitgliedern mit Link auf die Rechnung.<br/>
                Der versandte Link enthÃ¤lt das Token, ohne welches KEIN pdf generiert wird.
              </small>

            </td>
            <td>
              <a tal:condition="not member.dues18_12_invoice"
                 href="${request.route_url('send_dues18_12_invoice_email', member_id=member.id)}"
                 title="dues invoice not sent yet"
                 class="btn btn-warning">
                Noch nicht berechnet und verschickt. <br/>
                Jetzt berechnen &amp; versenden: Klick!</a>
              <a tal:condition="member.dues18_12_invoice"
                 href="${request.route_url('send_dues18_12_invoice_email', member_id=member.id)}"
                 title="gesendet ${member.dues18_12_invoice_date.strftime('am %d.%m.%Y um %H:%M')}"
                 class="btn btn-success">gesendet ${member.dues18_12_invoice_date.strftime('am %d.%m.%Y um %H:%M')}. Klicken zum wiederholten versenden.</a>
            </td>
          </tr>
          <tr tal:condition="'investing' not in member.membership_type and member.dues18_12_invoice">
            <td>PDF generieren (download)</td>
            <td>
              <a href="${request.route_url('make_dues18_12_invoice_no_pdf',
                       email=member.email,
                       code=member.dues18_12_token,
                       i=str(member.dues18_12_invoice_no).zfill(4))}"
                 title="Mitgliedschaftsbeitragsrechnung ansehen"
                 class="btn btn-success">PDF generieren und laden</a>
            </td>
          </tr>
          <!--! reduction / exemption -->
          <tr tal:condition="'investing' not in member.membership_type and member.dues18_12_invoice">
            <td>ErmÃ¤Ãigung/Erlass<br/>
              <small>
                Hier siehst Du den errechneten Mitgliedsbeitrag.<br/>
                Du kannst im Falle eines Antrags auf ErmÃ¤Ãigung einen neuen Betrag festsetzen -- auch 0 Euro.<br/>
                Daraufhin wird die alte Rechnung storniert.
                Das Mitglied erhÃ¤lt eine E-Mail.<br/>
                Diese enthÃ¤lt Links auf die Storno-Rechnung
                und eine neue geÃ¤nderte Rechnung.
              </small>
            </td>
            <td>
              <table>
                <tr>
                  <td><small>mÃ¼sste zahlen:</small></td>
                  <td>${member.dues18_12_start}</td>
                </tr>
                <tr>
                  <td><small>berechn. Beitrag: &nbsp;</small></td>
                  <td>${member.dues18_12_amount} Euro</td>
                </tr>
                <tr>
                  <td><small>ermÃ¤Ãigter Beitrag: &nbsp;</small></td>
                  <td tal:condition="not member.dues18_12_reduced">
                    kein Antrag gestellt</td>
                  <td tal:condition="member.dues18_12_reduced">
                    ${member.dues18_12_amount_reduced} Euro</td>
                </tr>
              </table>
              <p>

                <form tal:condition="not member.dues18_12_balanced"
                      id="dues18_12_form"
                      class="form-inline"
                      action="${request.route_url('dues18_12_reduction', member_id=member.id)}"
                      method="post">
                    <label>ermÃ¤Ãigen auf:</label>
                    <input type="hidden"
                           name="confirmed"
                           value="no" />
                    <input type="text"
                           class="form-control"
                           title="foo"
                           name="amount"
                           value="" />
                    <input id="dues18_12_reduce_submit"
                           type="submit"
                           name="submit"
                           class="btn btn-primary"
                           value="Reduce Dues" />
                </form>
              </p>
              <p tal:define="messages request.session.pop_flash('dues18_12_message_to_staff')"
                    tal:condition="messages"
                    tal:attributes="class 'alert alert-danger'">
                <span color="red"
                      tal:repeat="message messages">
                  ${message}
                </span><br />
              </p>
              <p>
                see also <a href="${request.route_url('dues18_12_listing')}"
                            class="btn btn-primary">Dues18_12 Invoices Listing</a>
              </p>
            </td>
          </tr>
          <!--! payments for dues -->
          <!--! case one: not paid yet -->
          <tr tal:condition="'investing' not in member.membership_type
                             and member.dues18_12_invoice
                             and not member.dues18_12_paid
                             and not member.dues18_12_balanced">
            <td>Zahlungseingang<br/>
              <small>
                Hier kann der Zahlungseingang mit Datum vermerkt werden.
              </small>
            </td>
            <td>
              <p>
                <form class="form-inline"
                      action="${request.route_url('dues18_12_notice', member_id=member.id)}"
                      method="post">
                  <label>Betrag eingegangen:</label>
                     <input type="text"
                           class="form-control"
                           title="foo"
                           name="amount"
                           value="" />
                     <br />
                     Eingangsdatum (yyyy-mm-dd):
                     <input name="payment_date"
                            class="form-control"
                            type="text"
                            value="${today}" />
                     <br />
                     <input name="submit" type="submit"
                            class="btn btn-primary"
                            value="Zahlungseingang bestÃ¤tigen." />
                </form>
              </p>
              <p tal:define="messages request.session.pop_flash('dues18_12notice_message_to_staff')"
                    tal:condition="messages"
                    tal:attributes="class 'alert alert-danger'">
                <span color="red"
                      tal:repeat="message messages">
                  ${message}
                </span><br />
              </p>
            </td>
          </tr>
          <!-- case two: already paid OR dues exempted-->
          <tr tal:condition="'investing' not in member.membership_type
                             and member.dues18_12_invoice
                             and member.dues18_12_paid
                             or member.dues18_12_balanced">
            <td>Zahlungseingang<br/>
              <small>
                Hier ist der Zahlungseingang mit Datum vermerkt.
              </small>
            </td>
            <td>
              <table class="table table-striped">
                <tr>
                  <td>Betrag eingegangen:</td><td>${member.dues18_12_amount_paid}</td>
                </tr><tr>
                  <td>Eingangsdatum:</td><td>${member.dues18_12_paid_date}</td>
                </tr>
              </table>
            </td>
          </tr>
          <tr tal:condition="'investing' not in member.membership_type and member.dues18_12_invoice">
            <td>Rechnungen<br/>
              <small>
                Hier siehst Du die erstellten Rechnungen fÃ¼r dieses Mitglied.<br/>
                Falls vorhanden in der vorletzten Zeile (Ã¼ber SALDO) auch einen Zahlungseingang.
              </small>
            </td>
            <td>
              <table class="table table-striped" rules="rows">
                <tr class="table-striped">
                  <th>invoice no</th>
                  <th>invoice string<br/>(download PDF)</th>
                  <th>date</th>
                  <th>amount</th>
                  <th>was<br/>reversed?</th>
                  <th>is<br/>reversal?</th>
                  <th>default or<br/>altered?</th>
                </tr>

                <!--! loop over the list of invoices -->
                <tr tal:define="global i_saldo python:0"
                    tal:repeat="i invoices18_12"
                    tal:attributes="id python: 'invoice_{0}'.format(i.id)">
                  <!-- td>${i.id}</td -->
                  <td><a title="${i.invoice_no}">${i.invoice_no}</a></td>
                  <td>
                    <!--! if this invoice is a normal invoice -->
                    <a tal:condition="not i.is_reversal"
                       href="${request.route_url('make_dues18_12_invoice_no_pdf',
                             i=str(i.invoice_no).zfill(4),
                             email=i.email,
                             code=i.token)}"
                       title="download ${i.invoice_no_string}.pdf">
                      ${i.invoice_no_string}
                    </a>
                    <!--! if this invoice is a REVERSAL INVOICE -->
                    <a  tal:condition="i.is_reversal"
                        href="${request.route_url('make_dues18_12_reversal_invoice_pdf',
                              no=str(i.invoice_no).zfill(4),
                              email=i.email,
                              code=i.token)}"
                        title="download ${i.invoice_no_string}-S.pdf">
                      ${i.invoice_no_string}
                    </a>
                  </td>
                  <td>${i.invoice_date.strftime('%d.%m.%Y %H:%M')}</td>
                  <td tal:define="global i_saldo python: D(i_saldo) + D(i.invoice_amount)">
                    ${i.invoice_amount}</td>
                  <td>${'reversed by %s' % i.succeeding_invoice_no if i.is_cancelled else ''}</td>
                  <td>${'reverses %s' % i.preceding_invoice_no if i.is_reversal else ''}</td>
                  <td>${'altered' if i.is_altered else ''}</td>
                </tr>
                <tr tal:condition="member.dues18_12_paid">
                  <td>n/a</td>
                  <td>Zahlungseingang</td>
                  <td>${member.dues18_12_paid_date.strftime('%Y-%m-%d')}</td>
                  <td tal:define="global i_saldo python: D(i_saldo) - D(member.dues18_12_amount_paid)">
                    ${member.dues18_12_amount_paid}</td>
                  <td></td>
                  <td></td>
                  <td></td>
                </tr>
                <tr>
                  <td></td>
                  <td>SALDO: </td>
                  <td></td>
                  <td>${i_saldo}</td>
                  <td></td>
                  <td></td>
                  <td></td>
                </tr>
              </table>
            </td>
          </tr>
        </table>
        </div>

        <a name="account_balance"></a>
        <h3 id="certificate">Account Balance</h3>
        <table class="table table-striped">
          <?python
            balance = 0

          ?>
          <tr>
            <th>Position</th>
            <th>Amount</th>
          </tr>
          <tr>
            <?python balance += member.dues18_05_balance ?>
            <td>Membership dues 2018-05</td>
            <td>${-member.dues18_05_balance}</td>
          </tr>
          <tr>
            <?python balance += member.dues18_06_balance ?>
            <td>Membership dues 2018-05</td>
            <td>${-member.dues18_06_balance}</td>
          </tr>
          <tr>
            <?python balance += member.dues18_07_balance ?>
            <td>Membership dues 2018-05</td>
            <td>${-member.dues18_07_balance}</td>
          </tr>
          <tr>
            <?python balance += member.dues18_08_balance ?>
            <td>Membership dues 2018-05</td>
            <td>${-member.dues18_08_balance}</td>
          </tr>
          <tr>
            <?python balance += member.dues18_09_balance ?>
            <td>Membership dues 2018-05</td>
            <td>${-member.dues18_09_balance}</td>
          </tr>
          <tr>
            <?python balance += member.dues18_10_balance ?>
            <td>Membership dues 2018-05</td>
            <td>${-member.dues18_10_balance}</td>
          </tr>
          <tr>
            <?python balance += member.dues18_11_balance ?>
            <td>Membership dues 2018-05</td>
            <td>${-member.dues18_11_balance}</td>
          </tr>
          <tr>
            <?python balance += member.dues18_12_balance ?>
            <td>Membership dues 2018-05</td>
            <td>${-member.dues18_12_balance}</td>
          </tr>
          <tr>
            <?python
                balanced = (balance == 0.0)

            ?>
            <th>Account balance</th>
            <th tal:condition="not balanced"
                class="alert alert-danger">
              ${-balance}
            </th>
            <th tal:condition="balanced"
                class="alert alert-success">
              ${-balance}
            </th>
          </tr>
        </table>
      </div>

  </tal:block>
</html>
